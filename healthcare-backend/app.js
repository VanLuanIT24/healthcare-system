// app.js
const express = require('express');
const cookieParser = require('cookie-parser');
const helmet = require('helmet');
const cors = require('cors');
const morgan = require('morgan');
const compression = require('compression');
const rateLimit = require('express-rate-limit');
const path = require('path');

const { appConfig } = require('./src/config');
const { initializeConfig } = require('./src/config');

// üéØ IMPORT ROUTES
const authRoutes = require('./src/routes/auth.routes');
const userRoutes = require('./src/routes/user.routes');
const superAdminRoutes = require('./src/routes/superAdmin.routes');

// üÜï TH√äM C√ÅC ROUTES KH√ÅC (khi c√≥)
// const patientRoutes = require('./src/routes/patient.routes');
// const appointmentRoutes = require('./src/routes/appointment.routes');
// const medicalRoutes = require('./src/routes/medical.routes');

/**
 * ·ª®NG D·ª§NG EXPRESS CH√çNH - ƒê√É C·∫¨P NH·∫¨T
 * - T√≠ch h·ª£p ƒë·∫ßy ƒë·ªß c√°c routes
 * - C·∫•u h√¨nh middleware b·∫£o m·∫≠t v√† hi·ªáu nƒÉng
 * - ƒê·ªãnh tuy·∫øn API endpoints ho√†n ch·ªânh
 */

// üöÄ KH·ªûI T·∫†O ·ª®NG D·ª§NG EXPRESS
const app = express();

// üîß KH·ªûI T·∫†O C·∫§U H√åNH H·ªÜ TH·ªêNG
initializeConfig().catch(error => {
  console.error('‚ùå L·ªói kh·ªüi t·∫°o c·∫•u h√¨nh:', error);
  process.exit(1);
});

// üîí MIDDLEWARE B·∫¢O M·∫¨T
app.use(helmet({
  crossOriginResourcePolicy: { policy: "cross-origin" },
  contentSecurityPolicy: {
    directives: {
      defaultSrc: ["'self'"],
      styleSrc: ["'self'", "'unsafe-inline'"],
      scriptSrc: ["'self'"],
      imgSrc: ["'self'", "data:", "https:"],
    },
  },
}));

// üåê CORS CONFIGURATION - C·∫¨P NH·∫¨T CHO FRONTEND
app.use(cors({
  origin: appConfig.cors.origin || ['http://localhost:3000', 'http://localhost:5173'],
  credentials: true,
  methods: ['GET', 'POST', 'PUT', 'DELETE', 'PATCH', 'OPTIONS'],
  allowedHeaders: [
    'Content-Type', 
    'Authorization', 
    'X-Requested-With',
    'X-Requested-By',
    'X-Emergency-Access' // üÜï TH√äM HEADER CHO EMERGENCY ACCESS
  ],
}));

// ‚ö° MIDDLEWARE HI·ªÜU NƒÇNG
app.use(compression()); // N√©n response
app.use(express.json({ limit: '10mb' })); // Gi·ªõi h·∫°n k√≠ch th∆∞·ªõc request
app.use(express.urlencoded({ extended: true, limit: '10mb' }));
app.use(cookieParser());

// üìä LOGGING MIDDLEWARE - C·∫¢I THI·ªÜN
app.use(morgan(appConfig.isDev ? 'dev' : 'combined', {
  skip: (req) => {
    // B·ªè log c√°c endpoint kh√¥ng c·∫ßn thi·∫øt
    return req.path === '/health' || 
           req.path === '/favicon.ico' ||
           req.method === 'OPTIONS';
  },
  stream: {
    write: (message) => {
      console.log(message.trim());
    }
  }
}));

// üõ°Ô∏è RATE LIMITING CHO API - C·∫¨P NH·∫¨T
const createRateLimiter = (windowMs, max, message) => {
  return rateLimit({
    windowMs,
    max,
    message: {
      success: false,
      error: message,
      code: 'RATE_LIMIT_EXCEEDED'
    },
    standardHeaders: true,
    legacyHeaders: false,
    skip: (req) => {
      // üÜï B·ªé QUA RATE LIMIT CHO HEALTH CHECK V√Ä M·ªòT S·ªê TR∆Ø·ªúNG H·ª¢P ƒê·∫∂C BI·ªÜT
      return req.path === '/health' || 
             req.method === 'OPTIONS' ||
             (req.headers['x-emergency-access'] === 'true' && appConfig.isDev);
    }
  });
};

// üéØ √ÅP D·ª§NG RATE LIMITING THEO T·ª™NG LO·∫†I
const generalLimiter = createRateLimiter(
  15 * 60 * 1000, // 15 ph√∫t
  appConfig.isDev ? 1000 : 200, // Gi·ªõi h·∫°n request
  'Qu√° nhi·ªÅu request t·ª´ IP n√†y, vui l√≤ng th·ª≠ l·∫°i sau 15 ph√∫t.'
);

const authLimiter = createRateLimiter(
  15 * 60 * 1000, // 15 ph√∫t
  appConfig.isDev ? 50 : 10, // Gi·ªõi h·∫°n th·∫•p h∆°n cho auth
  'Qu√° nhi·ªÅu attempt ƒëƒÉng nh·∫≠p, vui l√≤ng th·ª≠ l·∫°i sau 15 ph√∫t.'
);

const criticalLimiter = createRateLimiter(
  60 * 60 * 1000, // 1 gi·ªù
  appConfig.isDev ? 100 : 20, // Gi·ªõi h·∫°n r·∫•t th·∫•p cho API quan tr·ªçng
  'Qu√° nhi·ªÅu request t·ªõi API quan tr·ªçng, vui l√≤ng th·ª≠ l·∫°i sau 1 gi·ªù.'
);

// üéØ √ÅP D·ª§NG RATE LIMITING
app.use('/api/', generalLimiter);
app.use('/api/auth/', authLimiter);
app.use('/api/super-admin/', criticalLimiter);
app.use('/api/users/', generalLimiter);

// üè• HEALTH CHECK ENDPOINT - C·∫¢I THI·ªÜN
app.get('/health', (req, res) => {
  const healthCheck = {
    status: 'healthy',
    timestamp: new Date().toISOString(),
    uptime: process.uptime(),
    environment: appConfig.env,
    version: process.env.npm_package_version || '1.0.0',
    memory: process.memoryUsage(),
    nodeVersion: process.version,
    platform: process.platform
  };

  res.status(200).json(healthCheck);
});

// üÜï ROOT ENDPOINT - HI·ªÇN TH·ªä TH√îNG TIN API
app.get('/', (req, res) => {
  res.json({
    message: 'üè• Healthcare System API - ƒêang ho·∫°t ƒë·ªông',
    version: '1.0.0',
    environment: appConfig.env,
    timestamp: new Date().toISOString(),
    documentation: '/api/docs', // üÜï C√ì TH·ªÇ TH√äM SWAGGER SAU N√ÄY
    endpoints: {
      auth: '/api/auth',
      users: '/api/users',
      superAdmin: '/api/super-admin',
      health: '/health'
    }
  });
});

// üéØ API ROUTES - ƒê√É TH√äM USER ROUTES
app.use('/api/auth', authRoutes);
app.use('/api/users', userRoutes);
app.use('/api/super-admin', superAdminRoutes);

// üÜï TH√äM C√ÅC ROUTES KH√ÅC KHI C·∫¶N
// app.use('/api/patients', patientRoutes);
// app.use('/api/appointments', appointmentRoutes);
// app.use('/api/medical', medicalRoutes);

// üîç DEBUG ENDPOINT (ch·ªâ trong development) - C·∫¢I THI·ªÜN
if (appConfig.isDev) {
  app.get('/api/debug/config', (req, res) => {
    // üõ°Ô∏è ·∫®N TH√îNG TIN NH·∫†Y C·∫¢M
    const safeConfig = {
      environment: appConfig.env,
      port: appConfig.port,
      db: {
        host: appConfig.db.host ? '***' : undefined,
        name: appConfig.db.name
      },
      jwt: {
        accessExpiry: appConfig.jwt.accessExpiry,
        refreshExpiry: appConfig.jwt.refreshExpiry
      },
      security: {
        saltRounds: appConfig.security.saltRounds,
        maxLoginAttempts: appConfig.security.maxLoginAttempts
      },
      email: {
        smtpHost: appConfig.email.smtpHost,
        from: appConfig.email.from
      },
      cors: {
        origin: appConfig.cors.origin
      },
      logging: {
        level: appConfig.logging.level,
        enableAudit: appConfig.logging.enableAudit
      },
      hospital: {
        name: appConfig.hospital.name,
        supportEmail: appConfig.hospital.supportEmail
      }
    };

    res.json(safeConfig);
  });

  // üÜï ENDPOINT KI·ªÇM TRA ROUTES
  app.get('/api/debug/routes', (req, res) => {
    const routes = [];
    
    app._router.stack.forEach(middleware => {
      if (middleware.route) {
        // Routes tr·ª±c ti·∫øp
        const methods = Object.keys(middleware.route.methods).map(method => method.toUpperCase());
        routes.push({
          path: middleware.route.path,
          methods: methods
        });
      } else if (middleware.name === 'router') {
        // Router middleware
        middleware.handle.stack.forEach(handler => {
          if (handler.route) {
            const methods = Object.keys(handler.route.methods).map(method => method.toUpperCase());
            routes.push({
              path: middleware.regexp.toString().replace(/^\/\^\\|\\\/\?\(\?=\\\/\|\$\)\/\w/g, '') + handler.route.path,
              methods: methods
            });
          }
        });
      }
    });

    res.json({
      totalRoutes: routes.length,
      routes: routes
    });
  });
}

// ‚ùå HANDLE 404 - KH√îNG T√åM TH·∫§Y ROUTE - C·∫¢I THI·ªÜN
app.use((req, res, next) => {
  res.status(404).json({
    success: false,
    error: 'Kh√¥ng t√¨m th·∫•y endpoint',
    path: req.originalUrl,
    method: req.method,
    timestamp: new Date().toISOString(),
    suggestion: 'Ki·ªÉm tra l·∫°i ƒë∆∞·ªùng d·∫´n ho·∫∑c tham kh·∫£o documentation t·∫°i /api/docs'
  });
});

// üö® ERROR HANDLING MIDDLEWARE - C·∫¢I THI·ªÜN
app.use((error, req, res, next) => {
  console.error('üö® L·ªói h·ªá th·ªëng:', {
    message: error.message,
    stack: error.stack,
    url: req.originalUrl,
    method: req.method,
    ip: req.ip,
    userAgent: req.get('User-Agent')
  });

  // üéØ PH√ÇN LO·∫†I L·ªñI CHI TI·∫æT H∆†N
  if (error.name === 'ValidationError') {
    return res.status(400).json({
      success: false,
      error: 'D·ªØ li·ªáu kh√¥ng h·ª£p l·ªá',
      code: 'VALIDATION_ERROR',
      details: error.details?.map(detail => ({
        field: detail.path.join('.'),
        message: detail.message,
        type: detail.type
      })) || [error.message]
    });
  }

  if (error.name === 'JsonWebTokenError') {
    return res.status(401).json({
      success: false,
      error: 'Token kh√¥ng h·ª£p l·ªá',
      code: 'INVALID_TOKEN'
    });
  }

  if (error.name === 'TokenExpiredError') {
    return res.status(401).json({
      success: false,
      error: 'Token ƒë√£ h·∫øt h·∫°n',
      code: 'TOKEN_EXPIRED'
    });
  }

  if (error.code === 'LIMIT_FILE_SIZE') {
    return res.status(413).json({
      success: false,
      error: 'File qu√° l·ªõn',
      code: 'FILE_TOO_LARGE'
    });
  }

  // üéØ L·ªñI RBAC & PERMISSION
  if (error.code && error.code.startsWith('AUTH_')) {
    return res.status(error.statusCode || 403).json({
      success: false,
      error: error.message,
      code: error.code
    });
  }

  // üéØ L·ªñI DATABASE
  if (error.name === 'MongoError' || error.name === 'MongoServerError') {
    const dbError = appConfig.isDev ? error.message : 'L·ªói c∆° s·ªü d·ªØ li·ªáu';
    return res.status(500).json({
      success: false,
      error: dbError,
      code: 'DATABASE_ERROR'
    });
  }

  // üéØ L·ªñI M·∫∂C ƒê·ªäNH
  const statusCode = error.statusCode || error.status || 500;
  const message = appConfig.isDev ? error.message : 'ƒê√£ x·∫£y ra l·ªói h·ªá th·ªëng';

  res.status(statusCode).json({
    success: false,
    error: message,
    ...(appConfig.isDev && { 
      stack: error.stack,
      code: error.code 
    })
  });
});

// üÜï GRACEFUL SHUTDOWN HANDLING
process.on('SIGTERM', () => {
  console.log('üîÑ Nh·∫≠n t√≠n hi·ªáu SIGTERM, ƒëang t·∫Øt server...');
  process.exit(0);
});

process.on('SIGINT', () => {
  console.log('üîÑ Nh·∫≠n t√≠n hi·ªáu SIGINT, ƒëang t·∫Øt server...');
  process.exit(0);
});

module.exports = app;