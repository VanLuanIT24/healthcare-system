// healthcare-backend/src/constants/roles.js
/**
 * ğŸ¥ Há»† THá»NG PHÃ‚N QUYá»€N RBAC CHO á»¨NG Dá»¤NG Y Táº¾
 * TÃ¡c giáº£: Healthcare Development Team
 * PhiÃªn báº£n: 2.0 - ÄÃ£ refine báº£o máº­t & thá»±c táº¿ hÆ¡n (22/12/2025)
 * 
 * CÃ¡c thay Ä‘á»•i chÃ­nh so vá»›i báº£n gá»‘c:
 * - HOSPITAL_ADMIN khÃ´ng Ä‘Æ°á»£c táº¡o HOSPITAL_ADMIN khÃ¡c (chá»‰ SUPER_ADMIN má»›i Ä‘Æ°á»£c)
 * - ThÃªm PATIENT.UPDATE_ADMINISTRATIVE cho lá»… tÃ¢n cáº­p nháº­t thÃ´ng tin hÃ nh chÃ­nh
 * - DEPARTMENT_HEAD Ä‘Æ°á»£c register DOCTOR vÃ  NURSE trong khoa
 * - TÃ¡ch rÃµ APPOINTMENT.REQUEST_CANCEL (chá»‰ bá»‡nh nhÃ¢n) vÃ  CONFIRM_CANCEL
 * - CLINICAL_ADMIN cÃ³ thÃªm quyá»n register bÃ¡c sÄ© cao cáº¥p
 * - Cáº£i thiá»‡n comment vÃ  cáº¥u trÃºc
 */

const ROLES = Object.freeze({
  // ===== QUáº¢N TRá»Š Há»† THá»NG =====
  SUPER_ADMIN: 'SUPER_ADMIN',         // Quyá»n cao nháº¥t (dev ops)
  SYSTEM_ADMIN: 'SYSTEM_ADMIN',       // Quáº£n trá»‹ há»‡ thá»‘ng (khÃ´ng liÃªn quan y táº¿)
  CLINICAL_ADMIN: 'CLINICAL_ADMIN',   // BÃ¡c sÄ© trÆ°á»Ÿng cao cáº¥p

  // ===== QUáº¢N TRá»Š Bá»†NH VIá»†N & KHOA =====
  HOSPITAL_ADMIN: 'HOSPITAL_ADMIN',   // Quáº£n trá»‹ viÃªn bá»‡nh viá»‡n
  DEPARTMENT_HEAD: 'DEPARTMENT_HEAD', // TrÆ°á»Ÿng khoa/phÃ²ng

  // ===== NHÃ‚N VIÃŠN Y Táº¾ =====
  DOCTOR: 'DOCTOR',
  NURSE: 'NURSE',
  PHARMACIST: 'PHARMACIST',
  LAB_TECHNICIAN: 'LAB_TECHNICIAN',

  // ===== NHÃ‚N VIÃŠN HÃ€NH CHÃNH =====
  RECEPTIONIST: 'RECEPTIONIST',
  BILLING_STAFF: 'BILLING_STAFF',

  // ===== NGÆ¯á»œI DÃ™NG BÃŠN NGOÃ€I =====
  PATIENT: 'PATIENT',
  GUEST: 'GUEST',
});

// ===== DANH SÃCH QUYá»€N (PERMISSIONS) =====
const PERMISSIONS = Object.freeze({
  // ÄÄƒng nháº­p / ÄÄƒng kÃ½
  'AUTH_LOGIN': 'AUTH.LOGIN',
  'AUTH_LOGOUT': 'AUTH.LOGOUT',
  'AUTH_SELF_REGISTER': 'AUTH.SELF_REGISTER',

  // ÄÄƒng kÃ½ ngÆ°á»i dÃ¹ng (chá»‰ cáº¥p cho vai trÃ² cao)
  'AUTH_REGISTER_PATIENT': 'AUTH.REGISTER_PATIENT',
  'AUTH_REGISTER_RECEPTIONIST': 'AUTH.REGISTER_RECEPTIONIST',
  'AUTH_REGISTER_BILLING_STAFF': 'AUTH.REGISTER_BILLING_STAFF',
  'AUTH_REGISTER_LAB_TECHNICIAN': 'AUTH.REGISTER_LAB_TECHNICIAN',
  'AUTH_REGISTER_PHARMACIST': 'AUTH.REGISTER_PHARMACIST',
  'AUTH_REGISTER_NURSE': 'AUTH.REGISTER_NURSE',
  'AUTH_REGISTER_DOCTOR': 'AUTH.REGISTER_DOCTOR',
  'AUTH_REGISTER_DEPARTMENT_HEAD': 'AUTH.REGISTER_DEPARTMENT_HEAD',
  'AUTH_REGISTER_HOSPITAL_ADMIN': 'AUTH.REGISTER_HOSPITAL_ADMIN', // Chá»‰ SUPER_ADMIN

  // Quáº£n lÃ½ ngÆ°á»i dÃ¹ng
  'USER_VIEW': 'USER.VIEW',
  'USER_CREATE': 'USER.CREATE',
  'USER_UPDATE': 'USER.UPDATE',
  'USER_DELETE': 'USER.DELETE',
  'USER_DISABLE': 'USER.DISABLE', // Fixed: should be dot, matches usage in routes
  'USER_ENABLE': 'USER.ENABLE',
  'USER_RESTORE': 'USER.RESTORE',
  'USER_ASSIGN_DEPARTMENT': 'USER.ASSIGN_DEPARTMENT',
  'USER_VIEW_SENSITIVE': 'USER.VIEW_SENSITIVE',

  // Quáº£n lÃ½ bá»‡nh nhÃ¢n
  'PATIENT_VIEW': 'PATIENT.VIEW',
  'PATIENT_CREATE': 'PATIENT.CREATE',
  'PATIENT_UPDATE': 'PATIENT.UPDATE', // Update y táº¿ (bÃ¡c sÄ©)
  'PATIENT_UPDATE_ADMINISTRATIVE': 'PATIENT.UPDATE_ADMINISTRATIVE', // Update hÃ nh chÃ­nh (lá»… tÃ¢n)
  'PATIENT_DELETE': 'PATIENT.DELETE',
  'PATIENT_ADMIT': 'PATIENT.ADMIT',
  'PATIENT_DISCHARGE': 'PATIENT.DISCHARGE',
  'PATIENT_VIEW_SENSITIVE': 'PATIENT.VIEW_SENSITIVE',

  // Há»“ sÆ¡ bá»‡nh Ã¡n
  'MEDICAL_VIEW_RECORDS': 'MEDICAL.VIEW_RECORDS',
  'MEDICAL_CREATE_RECORDS': 'MEDICAL.CREATE_RECORDS',
  'MEDICAL_UPDATE_RECORDS': 'MEDICAL.UPDATE_RECORDS',
  'MEDICAL_EXPORT_RECORDS': 'MEDICAL.EXPORT_RECORDS',

  // TÆ° váº¥n / KhÃ¡m bá»‡nh
  'CONSULTATION_VIEW': 'CONSULTATION.VIEW',
  'CONSULTATION_CREATE': 'CONSULTATION.CREATE',
  'CONSULTATION_UPDATE': 'CONSULTATION.UPDATE',

  // Cháº©n Ä‘oÃ¡n
  'DIAGNOSIS_VIEW': 'DIAGNOSIS.VIEW',
  'DIAGNOSIS_CREATE': 'DIAGNOSIS.CREATE',
  'DIAGNOSIS_UPDATE': 'DIAGNOSIS.UPDATE',

  // Káº¿ hoáº¡ch Ä‘iá»u trá»‹
  'TREATMENT_VIEW_PLANS': 'TREATMENT.VIEW_PLANS',
  'TREATMENT_CREATE_PLANS': 'TREATMENT.CREATE_PLANS',
  'TREATMENT_UPDATE_PLANS': 'TREATMENT.UPDATE_PLANS',

  // ÄÆ¡n thuá»‘c
  'PRESCRIPTION_VIEW': 'PRESCRIPTION.VIEW',
  'PRESCRIPTION_CREATE': 'PRESCRIPTION.CREATE',
  'PRESCRIPTION_UPDATE_DRAFT': 'PRESCRIPTION.UPDATE_DRAFT',
  'PRESCRIPTION_APPROVE': 'PRESCRIPTION.APPROVE',
  'PRESCRIPTION_CANCEL': 'PRESCRIPTION.CANCEL',
  'PRESCRIPTION_DISPENSE': 'PRESCRIPTION.DISPENSE',

  // Lá»‹ch háº¹n
  'APPOINTMENT_VIEW': 'APPOINTMENT.VIEW',
  'APPOINTMENT_CREATE': 'APPOINTMENT.CREATE',
  'APPOINTMENT_UPDATE': 'APPOINTMENT.UPDATE',
  'APPOINTMENT_REQUEST_CANCEL': 'APPOINTMENT.REQUEST_CANCEL',   // Bá»‡nh nhÃ¢n yÃªu cáº§u há»§y
  'APPOINTMENT_CONFIRM_CANCEL': 'APPOINTMENT.CONFIRM_CANCEL',   // NhÃ¢n viÃªn duyá»‡t há»§y

  // HÃ ng Ä‘á»£i
  'QUEUE_VIEW': 'QUEUE.VIEW',
  'QUEUE_ADD': 'QUEUE.ADD',
  'QUEUE_WALK_IN': 'QUEUE.WALK_IN',
  'QUEUE_CALL_NEXT': 'QUEUE.CALL_NEXT',
  'QUEUE_SKIP': 'QUEUE.SKIP',
  'QUEUE_RECALL': 'QUEUE.RECALL',
  'QUEUE_COMPLETE': 'QUEUE.COMPLETE',
  'QUEUE_STATS': 'QUEUE.STATS',
  'QUEUE_WAIT_TIME': 'QUEUE.WAIT_TIME',

  // XÃ©t nghiá»‡m
  'LAB_VIEW_ORDERS': 'LAB.VIEW_ORDERS',
  'LAB_CREATE_ORDERS': 'LAB.CREATE_ORDERS',
  'LAB_UPDATE_ORDERS': 'LAB.UPDATE_ORDERS',
  'LAB_VIEW_RESULTS': 'LAB.VIEW_RESULTS',
  'LAB_CREATE_RESULTS': 'LAB.CREATE_RESULTS',
  'LAB_UPDATE_RESULTS': 'LAB.UPDATE_RESULTS',
  'LAB_APPROVE_RESULTS': 'LAB.APPROVE_RESULTS',

  // HÃ³a Ä‘Æ¡n / Thanh toÃ¡n
  'BILL_VIEW': 'BILL.VIEW',
  'BILL_CREATE': 'BILL.CREATE',
  'BILL_UPDATE': 'BILL.UPDATE',
  'BILL_PROCESS_PAYMENTS': 'BILL.PROCESS_PAYMENTS',
  'BILL_APPROVE_REFUND': 'BILL.APPROVE_REFUND',
  'BILL_VIEW_REPORTS': 'BILL.VIEW_REPORTS',

  // Quáº£n lÃ½ kho
  'INVENTORY_VIEW': 'INVENTORY.VIEW',
  'INVENTORY_UPDATE': 'INVENTORY.UPDATE',
  'INVENTORY_MANAGE_MEDICATION': 'INVENTORY.MANAGE_MEDICATION',
  'INVENTORY_CREATE': 'INVENTORY.CREATE',
  'INVENTORY_ADJUST': 'INVENTORY.ADJUST',
  'INVENTORY_ALERTS': 'INVENTORY.ALERTS',

  // Quáº£n lÃ½ giÆ°á»ng bá»‡nh
  'BED_VIEW': 'BED.VIEW',
  'BED_UPDATE': 'BED.UPDATE',
  'BED_ASSIGN': 'BED.ASSIGN',
  'BED_TRANSFER': 'BED.TRANSFER',
  'BED_DISCHARGE': 'BED.DISCHARGE',
  'BED_MANAGE': 'BED.MANAGE',
  'BED_VIEW_STATS': 'BED.VIEW_STATS',

  // ThÃ´ng bÃ¡o ná»™i bá»™
  'NOTIFICATION_VIEW': 'NOTIFICATION.VIEW',
  'NOTIFICATION_SEND': 'NOTIFICATION.SEND',
  'NOTIFICATION_SYSTEM': 'NOTIFICATION.SYSTEM',

  // BÃ¡o cÃ¡o
  'REPORT_VIEW': 'REPORT.VIEW',
  'REPORT_GENERATE': 'REPORT.GENERATE',
  'REPORT_EXPORT': 'REPORT.EXPORT',

  // Kháº©n cáº¥p & Há»‡ thá»‘ng
  'EMERGENCY_ACCESS': 'EMERGENCY.ACCESS',
  'SYSTEM_CONFIG': 'SYSTEM.CONFIG',
  'SYSTEM_VIEW_AUDIT_LOG': 'SYSTEM.VIEW_AUDIT_LOG',
  'SYSTEM_BACKUP_DATA': 'SYSTEM.BACKUP_DATA',

  // Dá»‹ch vá»¥ & Khoa
  'DEPARTMENT_VIEW': 'DEPARTMENT.VIEW',
  'DEPARTMENT_CREATE': 'DEPARTMENT.CREATE',
  'DEPARTMENT_UPDATE': 'DEPARTMENT.UPDATE',
  'DEPARTMENT_DELETE': 'DEPARTMENT.DELETE',
  'DEPARTMENT_MANAGE': 'DEPARTMENT.MANAGE',
  'SERVICE_VIEW': 'SERVICE.VIEW',
  'SERVICE_MANAGE': 'SERVICE.MANAGE',

  // Lá»‹ch lÃ m viá»‡c bÃ¡c sÄ©
  'SCHEDULE_VIEW': 'SCHEDULE.VIEW',
  'SCHEDULE_CREATE': 'SCHEDULE.CREATE',
  'SCHEDULE_UPDATE': 'SCHEDULE.UPDATE',
  'SCHEDULE_DELETE': 'SCHEDULE.DELETE',
  'SCHEDULE_MANAGE': 'SCHEDULE.MANAGE'
}); // â† ÄÃƒ Sá»¬A: ÄÃ³ng object PERMISSIONS Ä‘Ãºng cÃ¡ch

// ===== PHÃ‚N QUYá»€N THEO Tá»ªNG VAI TRÃ’ =====
const ROLE_PERMISSIONS = Object.freeze({
  [ROLES.SUPER_ADMIN]: [...Object.values(PERMISSIONS)], // ToÃ n quyá»n

  [ROLES.SYSTEM_ADMIN]: [
    PERMISSIONS.AUTH_LOGIN, PERMISSIONS.AUTH_LOGOUT,
    PERMISSIONS.USER_VIEW, PERMISSIONS.USER_CREATE, PERMISSIONS.USER_UPDATE,
    PERMISSIONS.USER_DISABLE, PERMISSIONS.USER_ENABLE, PERMISSIONS.USER_RESTORE,
    PERMISSIONS.USER_ASSIGN_DEPARTMENT,
    PERMISSIONS.REPORT_VIEW, PERMISSIONS.REPORT_EXPORT,
    PERMISSIONS.SYSTEM_CONFIG, PERMISSIONS.SYSTEM_VIEW_AUDIT_LOG,
    PERMISSIONS.SYSTEM_BACKUP_DATA,
    PERMISSIONS.BED_VIEW, PERMISSIONS.BED_MANAGE,
    PERMISSIONS.INVENTORY_CREATE, PERMISSIONS.INVENTORY_ADJUST, PERMISSIONS.INVENTORY_ALERTS,
    PERMISSIONS.NOTIFICATION_VIEW, PERMISSIONS.NOTIFICATION_SEND, PERMISSIONS.NOTIFICATION_SYSTEM,
  ],

  [ROLES.CLINICAL_ADMIN]: [
    PERMISSIONS.AUTH_LOGIN, PERMISSIONS.AUTH_LOGOUT,
    PERMISSIONS.USER_VIEW, PERMISSIONS.USER_UPDATE,
    PERMISSIONS.AUTH_REGISTER_DOCTOR, PERMISSIONS.AUTH_REGISTER_DEPARTMENT_HEAD,
    PERMISSIONS.PATIENT_VIEW, PERMISSIONS.PATIENT_VIEW_SENSITIVE,
    PERMISSIONS.MEDICAL_VIEW_RECORDS, PERMISSIONS.MEDICAL_EXPORT_RECORDS,
    PERMISSIONS.CONSULTATION_VIEW, PERMISSIONS.CONSULTATION_CREATE, PERMISSIONS.CONSULTATION_UPDATE,
    PERMISSIONS.DIAGNOSIS_VIEW, PERMISSIONS.DIAGNOSIS_CREATE, PERMISSIONS.DIAGNOSIS_UPDATE,
    PERMISSIONS.PRESCRIPTION_VIEW, PERMISSIONS.PRESCRIPTION_APPROVE,
    PERMISSIONS.LAB_VIEW_RESULTS, PERMISSIONS.LAB_APPROVE_RESULTS,
    PERMISSIONS.BED_VIEW, PERMISSIONS.BED_VIEW_STATS,
    PERMISSIONS.REPORT_VIEW, PERMISSIONS.REPORT_GENERATE, PERMISSIONS.REPORT_EXPORT,
    PERMISSIONS.EMERGENCY_ACCESS,
    PERMISSIONS.NOTIFICATION_VIEW,
    PERMISSIONS.QUEUE_VIEW, PERMISSIONS.QUEUE_STATS,
  ],

  [ROLES.HOSPITAL_ADMIN]: [
    PERMISSIONS.AUTH_LOGIN, PERMISSIONS.AUTH_LOGOUT,
    PERMISSIONS.USER_VIEW, PERMISSIONS.USER_CREATE, PERMISSIONS.USER_UPDATE,
    PERMISSIONS.USER_DISABLE, PERMISSIONS.USER_ENABLE, PERMISSIONS.USER_RESTORE,
    PERMISSIONS.USER_ASSIGN_DEPARTMENT,
    PERMISSIONS.AUTH_REGISTER_PATIENT, PERMISSIONS.AUTH_REGISTER_RECEPTIONIST,
    PERMISSIONS.AUTH_REGISTER_BILLING_STAFF, PERMISSIONS.AUTH_REGISTER_LAB_TECHNICIAN,
    PERMISSIONS.AUTH_REGISTER_PHARMACIST, PERMISSIONS.AUTH_REGISTER_NURSE,
    PERMISSIONS.AUTH_REGISTER_DOCTOR, PERMISSIONS.AUTH_REGISTER_DEPARTMENT_HEAD,
    // KhÃ´ng cÃ³ AUTH.REGISTER_HOSPITAL_ADMIN â†’ báº£o máº­t
    PERMISSIONS.PATIENT_VIEW, PERMISSIONS.PATIENT_CREATE,
    PERMISSIONS.PATIENT_UPDATE, PERMISSIONS.PATIENT_UPDATE_ADMINISTRATIVE,
    PERMISSIONS.PATIENT_ADMIT, PERMISSIONS.PATIENT_DISCHARGE,
    PERMISSIONS.MEDICAL_VIEW_RECORDS, PERMISSIONS.MEDICAL_EXPORT_RECORDS,
    PERMISSIONS.CONSULTATION_VIEW, PERMISSIONS.CONSULTATION_CREATE,
    PERMISSIONS.PRESCRIPTION_VIEW,
    PERMISSIONS.APPOINTMENT_VIEW, PERMISSIONS.APPOINTMENT_CREATE,
    PERMISSIONS.APPOINTMENT_CONFIRM_CANCEL,
    PERMISSIONS.LAB_VIEW_ORDERS, PERMISSIONS.LAB_VIEW_RESULTS,
    PERMISSIONS.BILL_VIEW, PERMISSIONS.BILL_CREATE, PERMISSIONS.BILL_PROCESS_PAYMENTS,
    PERMISSIONS.BILL_APPROVE_REFUND,
    PERMISSIONS.REPORT_VIEW, PERMISSIONS.REPORT_GENERATE, PERMISSIONS.REPORT_EXPORT,
    PERMISSIONS.INVENTORY_VIEW,
    PERMISSIONS.INVENTORY_CREATE, PERMISSIONS.INVENTORY_ADJUST, PERMISSIONS.INVENTORY_ALERTS,
    PERMISSIONS.BED_VIEW, PERMISSIONS.BED_ASSIGN, PERMISSIONS.BED_TRANSFER,
    PERMISSIONS.BED_DISCHARGE, PERMISSIONS.BED_MANAGE, PERMISSIONS.BED_VIEW_STATS,
    PERMISSIONS.NOTIFICATION_VIEW, PERMISSIONS.NOTIFICATION_SEND,
    PERMISSIONS.QUEUE_VIEW, PERMISSIONS.QUEUE_STATS, PERMISSIONS.QUEUE_WAIT_TIME,
    PERMISSIONS.EMERGENCY_ACCESS,
    PERMISSIONS.SYSTEM_VIEW_AUDIT_LOG,
    PERMISSIONS.SERVICE_VIEW,
    PERMISSIONS.SERVICE_MANAGE,
    PERMISSIONS.SCHEDULE_VIEW,
    PERMISSIONS.SCHEDULE_CREATE,
    PERMISSIONS.SCHEDULE_UPDATE,
    PERMISSIONS.SCHEDULE_DELETE,
    PERMISSIONS.SCHEDULE_MANAGE,
  ],

  [ROLES.DEPARTMENT_HEAD]: [
    PERMISSIONS.AUTH_LOGIN, PERMISSIONS.AUTH_LOGOUT,
    PERMISSIONS.USER_VIEW, PERMISSIONS.USER_UPDATE,
    PERMISSIONS.AUTH_REGISTER_DOCTOR, PERMISSIONS.AUTH_REGISTER_NURSE,
    PERMISSIONS.PATIENT_VIEW, PERMISSIONS.PATIENT_CREATE,
    PERMISSIONS.PATIENT_UPDATE, PERMISSIONS.PATIENT_UPDATE_ADMINISTRATIVE,
    PERMISSIONS.PATIENT_ADMIT, PERMISSIONS.PATIENT_DISCHARGE,
    PERMISSIONS.MEDICAL_VIEW_RECORDS, PERMISSIONS.MEDICAL_CREATE_RECORDS,
    PERMISSIONS.MEDICAL_UPDATE_RECORDS, PERMISSIONS.MEDICAL_EXPORT_RECORDS,
    PERMISSIONS.CONSULTATION_VIEW, PERMISSIONS.CONSULTATION_CREATE, PERMISSIONS.CONSULTATION_UPDATE,
    PERMISSIONS.DIAGNOSIS_VIEW, PERMISSIONS.DIAGNOSIS_CREATE, PERMISSIONS.DIAGNOSIS_UPDATE,
    PERMISSIONS.TREATMENT_VIEW_PLANS, PERMISSIONS.TREATMENT_CREATE_PLANS, PERMISSIONS.TREATMENT_UPDATE_PLANS,
    PERMISSIONS.PRESCRIPTION_VIEW, PERMISSIONS.PRESCRIPTION_CREATE, PERMISSIONS.PRESCRIPTION_UPDATE_DRAFT,
    PERMISSIONS.PRESCRIPTION_APPROVE,
    PERMISSIONS.APPOINTMENT_VIEW, PERMISSIONS.APPOINTMENT_CREATE, PERMISSIONS.APPOINTMENT_UPDATE,
    PERMISSIONS.QUEUE_VIEW, PERMISSIONS.QUEUE_CALL_NEXT, PERMISSIONS.QUEUE_SKIP, PERMISSIONS.QUEUE_RECALL, PERMISSIONS.QUEUE_COMPLETE, PERMISSIONS.QUEUE_WAIT_TIME,
    PERMISSIONS.APPOINTMENT_CONFIRM_CANCEL,
    PERMISSIONS.LAB_VIEW_ORDERS, PERMISSIONS.LAB_CREATE_ORDERS, PERMISSIONS.LAB_VIEW_RESULTS,
    PERMISSIONS.LAB_APPROVE_RESULTS,
    PERMISSIONS.BED_VIEW, PERMISSIONS.BED_ASSIGN, PERMISSIONS.BED_TRANSFER, PERMISSIONS.BED_DISCHARGE,
    PERMISSIONS.REPORT_VIEW, PERMISSIONS.REPORT_GENERATE,
    PERMISSIONS.QUEUE_VIEW, PERMISSIONS.QUEUE_STATS, PERMISSIONS.QUEUE_WAIT_TIME,
    PERMISSIONS.EMERGENCY_ACCESS,
    PERMISSIONS.NOTIFICATION_VIEW,
    PERMISSIONS.SCHEDULE_VIEW,
    PERMISSIONS.SCHEDULE_CREATE,
    PERMISSIONS.SCHEDULE_UPDATE,
    PERMISSIONS.SCHEDULE_DELETE,
    PERMISSIONS.SCHEDULE_MANAGE,
  ],

  [ROLES.DOCTOR]: [
    PERMISSIONS.AUTH_LOGIN, PERMISSIONS.AUTH_LOGOUT,
    PERMISSIONS.USER_VIEW,
    PERMISSIONS.PATIENT_VIEW, PERMISSIONS.PATIENT_UPDATE,
    PERMISSIONS.PATIENT_ADMIT, PERMISSIONS.PATIENT_DISCHARGE,
    PERMISSIONS.MEDICAL_VIEW_RECORDS, PERMISSIONS.MEDICAL_CREATE_RECORDS, PERMISSIONS.MEDICAL_UPDATE_RECORDS,
    PERMISSIONS.CONSULTATION_VIEW, PERMISSIONS.CONSULTATION_CREATE, PERMISSIONS.CONSULTATION_UPDATE,
    PERMISSIONS.DIAGNOSIS_VIEW, PERMISSIONS.DIAGNOSIS_CREATE, PERMISSIONS.DIAGNOSIS_UPDATE,
    PERMISSIONS.TREATMENT_VIEW_PLANS, PERMISSIONS.TREATMENT_CREATE_PLANS, PERMISSIONS.TREATMENT_UPDATE_PLANS,
    PERMISSIONS.PRESCRIPTION_VIEW, PERMISSIONS.PRESCRIPTION_CREATE, PERMISSIONS.PRESCRIPTION_UPDATE_DRAFT,
    PERMISSIONS.PRESCRIPTION_APPROVE,
    PERMISSIONS.APPOINTMENT_VIEW, PERMISSIONS.APPOINTMENT_CREATE, PERMISSIONS.APPOINTMENT_UPDATE,
    PERMISSIONS.LAB_VIEW_ORDERS, PERMISSIONS.LAB_CREATE_ORDERS, PERMISSIONS.LAB_VIEW_RESULTS,
    PERMISSIONS.LAB_CREATE_RESULTS, PERMISSIONS.LAB_APPROVE_RESULTS,
    PERMISSIONS.BED_VIEW, PERMISSIONS.BED_ASSIGN, PERMISSIONS.BED_TRANSFER, PERMISSIONS.BED_DISCHARGE, PERMISSIONS.BED_VIEW_STATS,
    PERMISSIONS.NOTIFICATION_VIEW,
    PERMISSIONS.INVENTORY_VIEW,
    PERMISSIONS.EMERGENCY_ACCESS,
    PERMISSIONS.SCHEDULE_VIEW,
  ],

  [ROLES.NURSE]: [
    PERMISSIONS.AUTH_LOGIN, PERMISSIONS.AUTH_LOGOUT,
    PERMISSIONS.USER_VIEW,
    PERMISSIONS.PATIENT_VIEW, PERMISSIONS.PATIENT_UPDATE,
    PERMISSIONS.MEDICAL_VIEW_RECORDS, PERMISSIONS.MEDICAL_UPDATE_RECORDS,
    PERMISSIONS.CONSULTATION_VIEW, PERMISSIONS.CONSULTATION_UPDATE,
    PERMISSIONS.DIAGNOSIS_VIEW,
    PERMISSIONS.TREATMENT_VIEW_PLANS, PERMISSIONS.TREATMENT_UPDATE_PLANS,
    PERMISSIONS.PRESCRIPTION_VIEW,
    PERMISSIONS.APPOINTMENT_VIEW, PERMISSIONS.APPOINTMENT_UPDATE,
    PERMISSIONS.LAB_VIEW_ORDERS, PERMISSIONS.LAB_VIEW_RESULTS, PERMISSIONS.LAB_CREATE_RESULTS,
    PERMISSIONS.QUEUE_VIEW, PERMISSIONS.QUEUE_SKIP, PERMISSIONS.QUEUE_WAIT_TIME,
    PERMISSIONS.EMERGENCY_ACCESS,
  ],

  [ROLES.PHARMACIST]: [
    PERMISSIONS.AUTH_LOGIN, PERMISSIONS.AUTH_LOGOUT,
    PERMISSIONS.USER_VIEW,
    PERMISSIONS.PRESCRIPTION_VIEW, PERMISSIONS.PRESCRIPTION_DISPENSE,
    PERMISSIONS.PRESCRIPTION_CANCEL,
    PERMISSIONS.INVENTORY_VIEW, PERMISSIONS.INVENTORY_UPDATE, PERMISSIONS.INVENTORY_MANAGE_MEDICATION,
  ],

  [ROLES.LAB_TECHNICIAN]: [
    PERMISSIONS.AUTH_LOGIN, PERMISSIONS.AUTH_LOGOUT,
    PERMISSIONS.USER_VIEW,
    PERMISSIONS.LAB_VIEW_ORDERS, PERMISSIONS.LAB_UPDATE_ORDERS,
    PERMISSIONS.LAB_VIEW_RESULTS, PERMISSIONS.LAB_CREATE_RESULTS, PERMISSIONS.LAB_UPDATE_RESULTS,
  ],

  [ROLES.RECEPTIONIST]: [
    PERMISSIONS.AUTH_LOGIN, PERMISSIONS.AUTH_LOGOUT,
    PERMISSIONS.AUTH_REGISTER_PATIENT,
    PERMISSIONS.USER_VIEW,
    PERMISSIONS.PATIENT_VIEW, PERMISSIONS.PATIENT_CREATE, PERMISSIONS.PATIENT_UPDATE_ADMINISTRATIVE,
    PERMISSIONS.APPOINTMENT_VIEW, PERMISSIONS.APPOINTMENT_CREATE, PERMISSIONS.APPOINTMENT_UPDATE,
    PERMISSIONS.APPOINTMENT_CONFIRM_CANCEL,
    PERMISSIONS.QUEUE_VIEW, PERMISSIONS.QUEUE_ADD, PERMISSIONS.QUEUE_WALK_IN, PERMISSIONS.QUEUE_WAIT_TIME,
    PERMISSIONS.BILL_VIEW,
  ],

  [ROLES.BILLING_STAFF]: [
    PERMISSIONS.AUTH_LOGIN, PERMISSIONS.AUTH_LOGOUT,
    PERMISSIONS.USER_VIEW,
    PERMISSIONS.BILL_VIEW, PERMISSIONS.BILL_CREATE, PERMISSIONS.BILL_UPDATE,
    PERMISSIONS.BILL_PROCESS_PAYMENTS, PERMISSIONS.BILL_APPROVE_REFUND,
    PERMISSIONS.BILL_VIEW_REPORTS,
  ],

  [ROLES.PATIENT]: [
    PERMISSIONS.AUTH_LOGIN, PERMISSIONS.AUTH_LOGOUT,
    PERMISSIONS.MEDICAL_VIEW_RECORDS,
    PERMISSIONS.CONSULTATION_VIEW,
    PERMISSIONS.DIAGNOSIS_VIEW,
    PERMISSIONS.PRESCRIPTION_VIEW,
    PERMISSIONS.APPOINTMENT_VIEW, PERMISSIONS.APPOINTMENT_CREATE,
    PERMISSIONS.APPOINTMENT_REQUEST_CANCEL,
    PERMISSIONS.BILL_VIEW,
    PERMISSIONS.LAB_VIEW_RESULTS,
    PERMISSIONS.NOTIFICATION_VIEW,
  ],

  [ROLES.GUEST]: [
    PERMISSIONS.AUTH_LOGIN,
    PERMISSIONS.AUTH_SELF_REGISTER,
  ],
});

// ===== PHÃ‚N Cáº¤P VAI TRÃ’ (HIERARCHY) =====
const ROLE_HIERARCHY = [
  ROLES.SUPER_ADMIN,
  ROLES.SYSTEM_ADMIN,
  ROLES.CLINICAL_ADMIN,
  ROLES.HOSPITAL_ADMIN,
  ROLES.DEPARTMENT_HEAD,
  ROLES.DOCTOR,
  ROLES.PHARMACIST,
  ROLES.NURSE,
  ROLES.LAB_TECHNICIAN,
  ROLES.BILLING_STAFF,
  ROLES.RECEPTIONIST,
  ROLES.PATIENT,
  ROLES.GUEST,
];

const ROLE_WEIGHTS = Object.freeze({
  [ROLES.SUPER_ADMIN]: 0,
  [ROLES.SYSTEM_ADMIN]: 1,
  [ROLES.CLINICAL_ADMIN]: 2,
  [ROLES.HOSPITAL_ADMIN]: 3,
  [ROLES.DEPARTMENT_HEAD]: 4,
  [ROLES.DOCTOR]: 5,
  [ROLES.PHARMACIST]: 6,
  [ROLES.NURSE]: 7,
  [ROLES.LAB_TECHNICIAN]: 8,
  [ROLES.BILLING_STAFF]: 9,
  [ROLES.RECEPTIONIST]: 10,
  [ROLES.PATIENT]: 11,
  [ROLES.GUEST]: 12,
});

// ===== CÃC HÃ€M Há»– TRá»¢ KIá»‚M TRA QUYá»€N =====
function hasPermission(role, permission) {
  if (!role || !permission) {
    console.warn('âŒ [RBAC] Thiáº¿u role hoáº·c permission:', { role, permission });
    return false;
  }
  const permissions = ROLE_PERMISSIONS[role];
  if (!permissions) {
    console.warn('âŒ [RBAC] KhÃ´ng tÃ¬m tháº¥y vai trÃ²:', role);
    return false;
  }
  return permissions.includes(permission);
}

function canCreateRole(currentRole, targetRole) {
  if (!currentRole || !targetRole) return false;
  if (currentRole === ROLES.SUPER_ADMIN) return targetRole !== ROLES.SUPER_ADMIN;
  const currentWeight = ROLE_WEIGHTS[currentRole];
  const targetWeight = ROLE_WEIGHTS[targetRole];
  return currentWeight !== undefined && targetWeight !== undefined && targetWeight > currentWeight;
}

function canAccessPatientData(userRole, patientId, accessorId, isEmergency = false) {
  if (isEmergency && hasPermission(userRole, PERMISSIONS.EMERGENCY_ACCESS)) {
    return true;
  }
  if (userRole === ROLES.PATIENT) {
    return patientId === accessorId;
  }
  const medicalStaff = [ROLES.DOCTOR, ROLES.NURSE, ROLES.DEPARTMENT_HEAD, ROLES.HOSPITAL_ADMIN, ROLES.CLINICAL_ADMIN, ROLES.SUPER_ADMIN];
  if (medicalStaff.includes(userRole)) {
    return hasPermission(userRole, PERMISSIONS.MEDICAL_VIEW_RECORDS);
  }
  if ([ROLES.RECEPTIONIST, ROLES.BILLING_STAFF].includes(userRole)) {
    return hasPermission(userRole, PERMISSIONS.PATIENT_VIEW);
  }
  return false;
}

function getCreatableRoles(currentRole) {
  return ROLE_HIERARCHY.filter(target => canCreateRole(currentRole, target));
}

function hasModuleAccess(role, module) {
  const modulePermissions = Object.values(PERMISSIONS).filter(p => p.startsWith(`${module}.`));
  return modulePermissions.some(perm => hasPermission(role, perm));
}

function getRolePermissions(role) {
  return ROLE_PERMISSIONS[role] || [];
}

function canManageUser(currentRole, targetRole) {
  return canCreateRole(currentRole, targetRole);
}

function getPermissionsByGroup() {
  const groups = {};
  Object.values(PERMISSIONS).forEach(permission => {
    const [group] = permission.split('.');
    if (!groups[group]) groups[group] = [];
    groups[group].push(permission);
  });
  return groups;
}

// ===== EXPORT =====
module.exports = {
  ROLES,
  PERMISSIONS,
  ROLE_PERMISSIONS,
  ROLE_HIERARCHY,
  ROLE_WEIGHTS,
  hasPermission,
  canCreateRole,
  canAccessPatientData,
  getCreatableRoles,
  hasModuleAccess,
  getRolePermissions,
  canManageUser,
  getPermissionsByGroup,
};

// ===== DEBUG KHI CHáº Y TRá»°C TIáº¾P FILE =====
if (require.main === module) {
  console.log('=== KIá»‚M TRA Há»† THá»NG RBAC ===\n');
  const testCases = [
    { current: ROLES.SUPER_ADMIN, target: ROLES.DOCTOR, expected: true },
    { current: ROLES.SUPER_ADMIN, target: ROLES.HOSPITAL_ADMIN, expected: true },
    { current: ROLES.SUPER_ADMIN, target: ROLES.SUPER_ADMIN, expected: false },
    { current: ROLES.HOSPITAL_ADMIN, target: ROLES.DOCTOR, expected: true },
    { current: ROLES.HOSPITAL_ADMIN, target: ROLES.DEPARTMENT_HEAD, expected: true },
    { current: ROLES.HOSPITAL_ADMIN, target: ROLES.HOSPITAL_ADMIN, expected: false },
    { current: ROLES.DEPARTMENT_HEAD, target: ROLES.DOCTOR, expected: true },
    { current: ROLES.DOCTOR, target: ROLES.NURSE, expected: false },
  ];
  testCases.forEach((test, i) => {
    const result = canCreateRole(test.current, test.target);
    const status = result === test.expected ? 'âœ…' : 'âŒ';
    console.log(`${status} Test ${i + 1}: ${test.current} cÃ³ thá»ƒ táº¡o ${test.target} â†’ ${result}`);
  });
}